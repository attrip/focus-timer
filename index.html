<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>集中タイマー</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');

  :root{
    --primary-color:#4cc9f0; --max-width:720px;
    /* Light */
    --bg-color:#0f0f0f; --widget-bg-color:#1a1a1a; --text-color:#e6e6e6;
    --heading-color:#4cc9f0; --border-color:rgba(255,255,255,.12);
    --input-bg-color:#242424; --input-text-color:#f2f2f2; --input-placeholder-color:rgba(255,255,255,.45);
    --btn-secondary-bg:#2b2b2b; --btn-secondary-hover-bg:#3a3a3a;
    --btn-tpl-bg:#262626; --btn-tpl-text:#f1f1f1; --btn-tpl-hover-bg:#f1f1f1; --btn-tpl-hover-text:#111;
    --log-bg-color:#141414; --history-item-hover-bg:#222;
  }

  body{
    font-family:'Noto Sans JP',sans-serif; display:flex; flex-direction:column; align-items:center;
    min-height:100vh; margin:0; padding:20px 0; box-sizing:border-box;
    background:var(--bg-color); color:var(--text-color);
  }

  .timer-container,.writer-container{
    max-width:var(--max-width); width:100%; padding:clamp(1rem,3vw,2rem);
    background:var(--widget-bg-color); border-radius:12px; border:1px solid var(--border-color);
    box-shadow:0 8px 24px rgba(0,0,0,.3); margin-bottom:20px;
  }
  .timer-container{text-align:center;}
  /* タイトルは不要なので非表示（ユーザー要望準拠） */
  .timer-container h1{display:none;}
  #timer-display{font-size:clamp(3rem,9vw,5.5rem); font-weight:700; line-height:1; margin:1rem 0 0.5rem;}

  /* 小さなトグル（必要なら使う） */
  .timer-controls{display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-top:.5rem;}
  .presets button,.controls button,.writer-container button{
    font-family:inherit; font-size:16px; font-weight:600; border:none; border-radius:8px;
    cursor:pointer; transition:all .2s ease; min-height:44px; padding:10px 16px;
  }
  .presets button{margin:.25rem; background:var(--btn-secondary-bg); color:var(--text-color);}
  .presets button:hover{background:var(--btn-secondary-hover-bg);}
  .controls button{margin:.25rem; background:var(--primary-color); color:#000; font-weight:800;}
  .controls button:hover{filter:brightness(.95);}
  button:focus-visible,input:focus-visible{outline:3px solid var(--primary-color); outline-offset:2px; box-shadow:0 0 0 4px rgba(76,201,240,.25);}

  /* ステータスバー */
  #status-bar{display:flex; justify-content:space-between; align-items:center; font-size:14px; margin-bottom:10px; opacity:.9; gap:12px; flex-wrap:wrap;}
  #topic-now{font-weight:700; letter-spacing:.02em; display:none;} /* 最初は非表示、1行目で表示 */

  /* 出力欄（500px固定） */
  #log{
    height:400px; overflow-y:auto;
    font-size:20px; line-height:1.8; margin:0; padding:12px; position:relative;
    border:1px solid var(--border-color); border-radius:10px; background:var(--log-bg-color);
  }
  #log::-webkit-scrollbar{width:6px;} #log::-webkit-scrollbar-thumb{background:var(--border-color); border-radius:3px;}
  #log div{opacity:0; transform:translateY(16px); animation:fadeIn .4s ease forwards;}
  @keyframes fadeIn{to{opacity:1; transform:translateY(0);}}

  #input-line{display:flex; flex-direction:column; align-items:stretch; gap:10px; margin-top:10px;}
  #input-field{
    font-size:18px; padding:12px 16px; width:100%; border:1px solid var(--border-color); border-radius:12px;
    background:var(--input-bg-color); color:var(--input-text-color); outline:none; transition:all .25s; box-sizing:border-box;
  }
  #input-field::placeholder{color:var(--input-placeholder-color); font-style:italic;}

  /* アコーディオン（削除済み） */

  .writer-actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
  #undo-button,#copy-button,#history-button{font-size:14px; padding:8px 14px; background:var(--btn-tpl-bg); color:var(--btn-tpl-text); border:1px solid var(--border-color);}
  #history-button{background:#2d2d2d;}

  #history-panel{display:none; position:fixed; top:0; right:0; width:clamp(300px,85vw,360px); height:100%;
    background:var(--widget-bg-color); box-shadow:-5px 0 15px rgba(0,0,0,.35); padding:20px; box-sizing:border-box; z-index:100;
    flex-direction:column; border-left:1px solid var(--border-color);}
  #history-panel h2{margin-top:0;}
  #history-list{list-style:none; padding:0; margin:0; overflow-y:auto; flex-grow:1;}
  #history-list li{padding:12px 10px; border-bottom:1px solid var(--border-color); cursor:pointer; line-height:1.4;}
  #history-list li:hover{background:var(--history-item-hover-bg);}
  #clear-history-button{margin-top:10px; background:#ff4444; color:#fff; width:100%; border:none; border-radius:8px; padding:10px 14px;}

  /* ダーク切替ボタン */
  #dark-mode-toggle{
    position:fixed; top:15px; right:15px; width:45px; height:45px; border-radius:50%;
    border:1px solid var(--border-color); background:var(--widget-bg-color); color:var(--text-color);
    cursor:pointer; font-size:22px; display:flex; align-items:center; justify-content:center; z-index:101;
  }

  @media (max-width:480px){
    #timer-display{font-size:clamp(2.4rem,16vw,4rem);}
    .presets button,.controls button{flex:1 1 auto; width:100%;}
    .writer-actions{flex-direction:column;}
  }
</style>
</head>
<body>
  <button id="dark-mode-toggle">🌙</button>

  <div class="timer-container">
    <h1>集中タイマー</h1>
    <div id="timer-display" role="timer" aria-live="assertive">25:00</div>
    <div class="timer-controls">
      <div class="presets" aria-label="プリセット時間">
        <button data-time="1500">25分</button>
        <button data-time="300">5分</button>
        <button data-time="900">15分</button>
      </div>
      <div class="controls" aria-label="タイマー操作">
        <button id="start-stop">スタート</button>
        <button id="reset">リセット</button>
      </div>
    </div>
  </div>

  <div class="writer-container">
    <div id="status-bar">
      <div id="topic-now"></div>
      <div style="display:flex; gap:12px; align-items:center;">
        <div id="char-count">📝 文字数：0字</div>
        <div id="cpm">✏️ 0文字/分</div>
        <div id="writer-timer">⏱ 経過時間：0分00秒</div>
      </div>
    </div>

    <div id="log">
      <div id="fixed-question" style="opacity:.6;">まず今日は何について書こうか？</div>
    </div>

    <div id="input-line">
      <input id="input-field" type="text" placeholder="一行目に『今日のフォーカス』を書いて Enter" autocomplete="off"/>

      <!-- 定型アコーディオンは要望により削除 -->

      <div class="writer-actions">
        <button id="undo-button" title="⌘/Ctrl+Z">取り消し</button>
        <button id="copy-button">まとめてコピー ＆ 保存</button>
        <button id="history-button">履歴</button>
      </div>
    </div>
  </div>

  <div id="history-panel" role="dialog" aria-modal="true" aria-label="保存したログ">
    <h2>保存したログ</h2>
    <ul id="history-list"></ul>
    <button id="clear-history-button">履歴を全削除</button>
  </div>

<script>
  // --- DOM refs ---
  const timerDisplay = document.getElementById('timer-display');
  const startStopBtn = document.getElementById('start-stop');
  const resetBtn = document.getElementById('reset');
  const presetBtns = document.querySelectorAll('.presets button');

  const writerInput = document.getElementById('input-field');
  const writerLog = document.getElementById('log');
  const copyBtn = document.getElementById('copy-button');
  const charCount = document.getElementById('char-count');
  const cpmDisplay = document.getElementById('cpm');
  const writerTimerDisplay = document.getElementById('writer-timer');
  const topicNow = document.getElementById('topic-now');

  const historyBtn = document.getElementById('history-button');
  const historyPanel = document.getElementById('history-panel');
  const historyList = document.getElementById('history-list');
  const clearHistoryBtn = document.getElementById('clear-history-button');
  const undoBtn = document.getElementById('undo-button');
  const darkModeToggle = document.getElementById('dark-mode-toggle');

  // --- State ---
  let timerId = null, totalSeconds = 1500, currentTime = 1500, isRunning = false;
  // マイルストーン通知（3/6/10/15/20分）
  let announced3 = false, announced6 = false, announced10 = false, announced15 = false, announced20 = false;
  let history = [], totalChars = 0, isComposing = false;
  const LOG_STORAGE_KEY = 'writer_logs';

  // --- Helpers ---
  function speak(text){
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text); u.lang = 'ja-JP'; window.speechSynthesis.speak(u);
  }
  function ensureNotificationPermission(){
    if('Notification' in window && Notification.permission === 'default'){
      Notification.requestPermission();
    }
  }
  function notifyUser(title, body){
    // Desktop notification (where supported), plus voice as fallback/extra
    try{
      if('Notification' in window && Notification.permission === 'granted'){
        new Notification(title, { body, silent:false });
      }
    }catch(e){ /* ignore */ }
    speak(`${title}。${body||''}`);
  }
  function updateDisplays(){
    const mm = Math.floor(currentTime/60).toString().padStart(2,'0');
    const ss = (currentTime%60).toString().padStart(2,'0');
    timerDisplay.textContent = `${mm}:${ss}`;
    document.title = `${mm}:${ss} - 集中タイマー`;

    const elapsed = totalSeconds - currentTime;
    const m = Math.floor(elapsed/60), s = elapsed%60;
    writerTimerDisplay.textContent = `⏱ 経過時間：${m}分${s.toString().padStart(2,'0')}秒`;
    cpmDisplay.textContent = `✏️ ${elapsed>0 ? Math.round((totalChars*60)/elapsed) : 0}文字/分`;
  }
  function checkAnnouncements(){
    const e = totalSeconds - currentTime;
    if(totalSeconds>=180 && e>=180 && !announced3){ notifyUser('3分経過', 'ウォームアップ完了'); announced3=true; }
    if(totalSeconds>=360 && e>=360 && !announced6){ notifyUser('6分経過', '集中に乗りました'); announced6=true; }
    if(totalSeconds>=600 && e>=600 && !announced10){ notifyUser('10分経過', '良いペースです'); announced10=true; }
    if(totalSeconds>=900 && e>=900 && !announced15){ notifyUser('15分経過', 'その調子！'); announced15=true; }
    if(totalSeconds>=1200 && e>=1200 && !announced20){ notifyUser('20分経過', 'ラストスパート'); announced20=true; }
  }
  function startTimer(){
    if(isRunning) return; isRunning=true; startStopBtn.textContent='ストップ'; writerInput.focus();
    ensureNotificationPermission();
    timerId=setInterval(()=>{
      currentTime--; updateDisplays();
      if(currentTime>=0){checkAnnouncements();}
      else{
        clearInterval(timerId);
        // 終了通知（音・デスクトップ通知・音声）
        new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA').play();
        const mins = Math.max(0, Math.round(totalSeconds/60));
        notifyUser('セッション終了', `${mins}分経過しました。お疲れさま！`);
        resetTimer();
      }
    },1000);
  }
  function stopTimer(){ if(!isRunning) return; isRunning=false; startStopBtn.textContent='スタート'; clearInterval(timerId); }
  function resetTimer(seconds=totalSeconds){
    stopTimer(); totalSeconds=seconds; currentTime=totalSeconds;
    announced3=announced6=announced10=announced15=announced20=false;
    updateDisplays();
  }

  function renderLogFromHistory(){
    writerLog.innerHTML='';
    if(history.length===0){
      writerLog.innerHTML='<div id="fixed-question" style="opacity:.6;">まず今日は何について書こうか？</div>';
      topicNow.style.display='none'; // 何も書いてなければ非表示
    }else{
      history.forEach(line=>{ const div=document.createElement('div'); div.textContent=line; writerLog.appendChild(div); });
    }
    writerLog.scrollTop = writerLog.scrollHeight;
  }
  function recalcCharCount(){
    totalChars = history.join('').length;
    charCount.textContent = `📝 文字数：${totalChars}字`;
  }

  function renderHistory(){
    const logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY)||'[]');
    historyList.innerHTML='';
    logs.forEach((log,idx)=>{
      const first = log.content[0]? (log.content[0].substring(0,30)+(log.content[0].length>30?'...':'')) : '(内容なし)';
      const li=document.createElement('li');
      li.innerHTML=`<span style="font-weight:bold; display:block; margin-bottom:4px;">${first}</span><small style="opacity:.7;">${new Date(log.timestamp).toLocaleString('ja-JP')} (${log.content.join('').length}字)</small>`;
      li.dataset.index=idx; li.addEventListener('click',()=>loadLog(idx)); historyList.appendChild(li);
    });
  }
  function loadLog(idx){
    const logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY)||'[]');
    const data = logs[idx]; if(!data) return;
    history = data.content.slice(); renderLogFromHistory(); recalcCharCount(); historyPanel.style.display='none';
    // トピック表示を先頭行から復元
    if(history[0]){ topicNow.textContent = `今は「${history[0]}」について書く`; topicNow.style.display='block'; }
  }

  // --- Events ---
  startStopBtn.addEventListener('click',()=>{ isRunning?stopTimer():startTimer(); });
  resetBtn.addEventListener('click',()=>resetTimer(totalSeconds));
  presetBtns.forEach(b=>b.addEventListener('click',()=>resetTimer(parseInt(b.dataset.time,10))));

  writerInput.addEventListener('compositionstart',()=>isComposing=true);
  writerInput.addEventListener('compositionend',()=>isComposing=false);

  writerInput.addEventListener('keydown',e=>{
    if(e.key==='z' && (e.metaKey||e.ctrlKey)){ e.preventDefault(); undoBtn.click(); return; }
    if(!isRunning && e.key!=='Enter'){ startTimer(); }
    if(e.key==='Enter' && !isComposing){
      e.preventDefault();
      const value = writerInput.value.trim();
      if(value!==''){
        const fixed = document.getElementById('fixed-question'); if(fixed) fixed.remove();
        const line=document.createElement('div'); line.textContent=value; writerLog.appendChild(line);
        history.push(value); writerInput.value=''; writerInput.focus(); writerLog.scrollTop=writerLog.scrollHeight; recalcCharCount();

        // 先頭行をトピックにする（初回のみセット）
        if(history.length===1){
          topicNow.textContent = `今は「${value}」について書く`;
          topicNow.style.display='block';
        }
      }
    }
    // ↑キーで最後の行を編集に戻す
    if(e.key==='ArrowUp' && writerInput.value.trim()==='' && history.length>0){
      e.preventDefault(); const last = history.pop(); writerInput.value=last; renderLogFromHistory(); recalcCharCount();
      if(history.length===0){ topicNow.style.display='none'; }
    }
  });

  // アコーディオンは削除済み（存在チェックで安全に無効化）
  const sectionAccordion = document.getElementById('section-accordion');
  if(sectionAccordion){
    sectionAccordion.addEventListener('click',e=>{
      const btn = e.target.closest('.sec-insert'); if(!btn) return;
      writerInput.value = btn.dataset.text || '';
      writerInput.focus();
      if(!isRunning) startTimer();
    });
  }

  // 履歴
  historyBtn.addEventListener('click',()=>{ historyPanel.style.display='flex'; renderHistory(); });
  clearHistoryBtn.addEventListener('click',()=>{
    if(confirm('本当にすべての履歴を削除しますか？')){
      localStorage.removeItem(LOG_STORAGE_KEY); renderHistory();
    }
  });
  document.addEventListener('click',e=>{ if(!historyPanel.contains(e.target) && e.target!==historyBtn){ historyPanel.style.display='none'; } });

  // Undo
  undoBtn.addEventListener('click',()=>{ if(history.length===0) return; history.pop(); renderLogFromHistory(); recalcCharCount(); writerInput.focus();
    if(history.length===0){ topicNow.style.display='none'; } });

  // コピー＆保存
  copyBtn.addEventListener('click',()=>{
    if(history.length===0) return;
    const text = history.join('\n');
    navigator.clipboard.writeText(text).then(()=>{
      const logs = JSON.parse(localStorage.getItem(LOG_STORAGE_KEY)||'[]');
      logs.unshift({timestamp:new Date().toISOString(), content:history.slice()});
      localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
      renderHistory();
      const oldLabel = copyBtn.textContent, oldBg = getComputedStyle(copyBtn).background;
      copyBtn.textContent = '🎉 コピーして保存完了！'; copyBtn.style.background = '#28a745'; copyBtn.style.transform = 'scale(1.03)';
      setTimeout(()=>{ copyBtn.textContent=oldLabel; copyBtn.style.background=oldBg; copyBtn.style.transform='none'; },1400);
    });
  });

  // ダークモード切替（トグル表示だけ）
  darkModeToggle.addEventListener('click',()=>{
    document.body.classList.toggle('light'); // デザインはダーク前提、必要ならここでカスタム
  });

  // 初期化
  (function init(){ updateDisplays(); })();
</script>
</body>
</html>
